---
title: "Econ 184b, Econometrics, Assignment 4"
output:
  html_document: default
  pdf_document: default
---

```{r,echo=F}
knitr::opts_chunk$set(message=F,warning=F)
```

```{r,echo=F,message=FALSE}
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(magrittr)
library(readr)
code_dir = dirname(rstudioapi::getActiveDocumentContext()$path)
knitr::opts_knit$set(root.dir=code_dir)
# setwd(code_dir)
```


The raw .rmd file for this assignment are available at: https://raw.githubusercontent.com/f1kidd/Econ184/main/Assignment/Assignment_4.Rmd

Note: For the math problems, you can either (1) type your solution and compile it with RMarkdown; (2) type your solution use another word-processing software and convert it into a PDF file; (3) write your solution on paper, scan it and make it into a legible PDF file. TAs can decide, at their discretion, that the submitted file is illegible and thus give zero credit to a question or the entire problem set. If you type your solutions (options 1 and 2 above), you will get **a bonus equal to 5% of your performance** on the problem set. No credit will be given if you only report the final answers without showing intermediate steps whenever appropriate. 

For the programming problems, you need to submit both the compiled pdf/html file and the RMarkdown (.rmd) file on LATTE. You will get **an additional bonus equal to 5% of your performance** if your RMarkdown file is completely reproducible with minimal altercation (install packages, etc.). That is, our team (or anyone else) should be able to recompile your Rmarkdown file and reach *the same* result. You need to explicitly write out your answers - just showing programming outputs will receive zero credit. 

You will be receiving a total of 15% bonus if you submit one single pdf/html compiled directly from Rmarkdown, along with the .rmd file. 

**The first three problems are based on the following setting.**

Suppose that you are studying the mortgage market. You have collected data on 78 households. For each household, you observe the following variables:

* "interest": the mortgage interest rate
* "income": annual income of the borrower
* "credit": the credit rating of the borrower. This is a categorical variable taking three possible values: high, medium and low.
* "self": whether or not the borrower is self-employed. This is a Bernoulli variable: 1 means "self-employed" and 0 means "not self-employed".

The goal is to explain "interest".

### Question 1:
Ignore "income" and "self". Run a regression of "interest" on "credit", i.e., predict "interest" using "credit". Consider the regression equation: $$interest = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + u$$

* $X_1$ is binary (1 means "medium" and 0 means "not medium")
* $X_2$ is binary (1 means "low" and 0 means "not low")

Answer the following questions:

a. We are interested in whether or not "credit" is useful in predicting "interest". Use the above regression equation and write down the null and alternative hypotheses.
b. We are interested in whether or not the prediction for someone with "credit"=medium is the same as the prediction for someone with "credit"=low. Use the above regression equation and write down the null and alternative hypotheses.
c. We are interested in whether or not the prediction for someone with "credit"=medium is the same as the prediction for someone with "credit"=high. Use the above regression equation and write down the null and alternative hypotheses.
d. In part (b), is the null hypothesis on individual regression coefficients? (Does it involve only one of $\beta_1$ and $\beta_2$?) If not, transform the regression equation such that we can study the same comparison in part (b) by testing only one coefficient in the transformed regression. In this case, write down the transformed regression equation and the null hypothesis based on the transformed regression.

## Answer

a. $$H0:\beta_1 = \beta_2 = 0$$
   $$H1:\beta_1 \neq 0\quad or\quad\beta_2 \neq 0$$
b. 
$$H0:\beta_1 = \beta_2 $$
   $$H1:\beta_1 \neq \beta_2 $$

c.
$$H0:\beta_1 = 0 $$
$$H1:\beta_1 \neq 0$$

d. No, the null hypothesis involves multiple coefficients ($\beta_1 \quad and \quad \beta_2$). There are two ways to transform this into a single hypothesis test:

1. (what I covered in class): transform the model into the following:

$$ interest = \gamma_0 + (\beta_1-\beta_2)X_1 + \beta_2(X_1+X_2) + u$$
where $\gamma_1 = \beta_1 - \beta_2$ is the coefficient for the transformed model. Hypothesis testing using $\gamma_1$ can be done with one-variable t-test. 

2. Create a new variable $X_3$=high (1 means "high" and 0 means "not high"). Mathematically, $X_3=1-X_1-X_2$. Run the regression: $$interest = \gamma_0 + \gamma_1 X_1 + \gamma_3 X_3 + u$$, and testing $\gamma_1=0$ will be the correct hypothesis test. 

Alternatively, run $interest = \gamma_0 + \gamma_2 X_2 + \gamma_3 X_3 + u$, and test $\gamma_2=0$.  


### Question 2

Ignore "income". Consider the following regression: $$interest = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_1X_3 + \beta_5 X_2X_3 + u$$

* $X_1$ is binary (1 means "medium" and 0 means "not medium")
* $X_2$ is binary (1 means "low" and 0 means "not low")
* $X_3$="self" ($X_3$=1 means "self-employed" and $X_3$=0 means "not self-employed")

Answer the following questions: 

a. What is the prediction for someone who has a medium credit rating and is self-employed? Write your answer in terms of $\beta_0,\beta_1,\beta_2,\beta_3,\beta_4,\beta_5$.
b. What is the prediction for someone who has a low credit rating and is self-employed? Write your answer in terms of $\beta_0,\beta_1,\beta_2,\beta_3,\beta_4,\beta_5$.
c. What is the prediction for someone who has a high credit rating and is self-employed? Write your answer in terms of $\beta_0,\beta_1,\beta_2,\beta_3,\beta_4,\beta_5$.
d. You have a theory: for those that are self-employed, the credit rating does not predict the interest rate of their mortgage. Write down the null and the alternative hypotheses for studying this theory.

## Answer

a. $$\beta_0 + \beta_1 + \beta_3+\beta_4$$

b. $$ \beta_0 + \beta_2 + \beta_3+\beta_5$$

c. $$ \beta_0 + \beta_3$$

d. Essentially we need to compare the predictions from the first three sub-questions are the same. Combining terms, we have:

$$ H0: \beta_2 + \beta_5 = 0 \quad and \quad \beta_1 + \beta_4 = 0$$
   $$ H1: \beta_2 + \beta_5 \neq 0 \quad or \quad \beta_1 + \beta_4 \neq 0$$


### Question 3

Ignore "self". Consider the following regression: $$interest = \beta_0 + \beta_1 X_1 + \beta_2 X_2 + \beta_3 X_3 + \beta_4 X_1X_3 + \beta_5 X_2X_3 + u$$

* $X_1$ is binary (1 means "medium" and 0 means "not medium")
* $X_2$ is binary (1 means "low" and 0 means "not low")
* $X_3$ = income

You use the above regression to study the effect of income on the mortgage interest rate. Answer the following questions: 

a. You have a theory: for those with a low credit rating, they always get the maximum interest rate, regardless of their income. (In other words, for those with a low credit rating, "income" does not predict "interest".) Use the above regression equation and write down the null and alternative hypotheses for studying this theory.
b. You are interested in finding out whether or not the effect of income on the interest rate depends on the credit rating. Use the above regression equation and write down the null and alternative hypotheses.

## Answer

a. 
For someone with a low credit rating, their predicted income is: $\beta_0 + \beta_2 + (\beta_3 + \beta_5) X_3$. The theory suggests that this predicted value is unrelated to income, which is essentially stating the following hypothesis:

$$ H_0: \beta_3+\beta_5=0 \quad vs. \quad H_1: \beta_3 + \beta_5 \neq 0$$

b. There are two ways to answer this question. 

1) You could follow the logic in part 2d and compare the predicted values of low, medium and high credit ratings, and set their pairwise differences to be unrelated to income. 

2) You could recognize that the interaction term $X_1X_3$ and $X_2X_3$ represent how the effect of income on interest rate depends on the credit rating. Thus we just need to test whether both of them are zero or not. The hypothesis is given as: 

$$H0: \beta_4 = 0 \quad and \quad \beta_5 = 0 $$
$$H1: \beta_4 \neq 0 \quad or \quad \beta_5 \neq 0 $$


### Question 4 :

Does a students GPA rise or fall as the student moves from freshman year to senior year? In this question you will explore this issue  and other factors that are correlated with GPA - using data on college students collected by researchers at the Harvard School of Public Health. The researchers surveyed 9,890 undergraduate students at 119 four-year colleges in 2001. Use the data set college.csv ("https://raw.githubusercontent.com/f1kidd/Econ184/main/Data/college.csv"). Make sure to use robust standard errors in your regressions.

a. Estimate the regression of GPA on *male* and *work*. Interpret the regression coefficients (including the intercept). 
b. Estimate the regression of GPA on *freshman*, *sophomore*, *junior* and *senior* for men only. Are all regression coefficients reported in the results? Explain what happened. What is the solution?
c. Estimate the regression of GPA on *sophomore*, *junior* and *senior* for men only. What is the interpretation of all coefficients in this regression (including the intercept)?
d. For the regression in (c), test the null hypothesis that there is no difference in the GPA of male sophomores and juniors. What is the number of restrictions q for this test?
e. For the regression in (c), test the null hypothesis that the coefficients on *sophomore*, *junior* and *senior* are all zero, against the alternative that at least one coefficient is nonzero. State clearly the significance level of the test you are using and the critical value of the F statistic for this test.
f. Estimate the regression of GPA on *age*, *sophomore*, *junior* and *senior* for men only. What happens to the statistical significance of the coefficients in this regression? Explain why this is the case. 
g. Estimate the same regression as in part (c), but now do this for all respondents (male and female). Include controls for *male*, *work*, *marijuana*, *lightdrinker*, *moddrinker* and *heavydrinker*. Calculate the predicted GPA for a male senior who works, is a moderate drinker and has not smoked marijuana in the past 30 days.
h. Using the regression in part (g), test the hypothesis (at the 5% significance level) that freshmen and sophomores have the same GPA on average, holding constant gender, work, type of drinking and marijuana use.
i. What is the adjusted R2 for the regression in part (h)? What does this adjusted R2 tell you about the fit of this regression? Does it indicate that omitted variable bias is likely to be a problem?

Your code could look like the following:

```{r}
library(tidyverse)
library(lmtest)
library(sandwich)
library(car)
data = read_csv("https://raw.githubusercontent.com/f1kidd/Econ184/main/Data/college.csv")
reg1 = lm(gpa~male+ work, data=data)
coeftest(reg1, vcov=vcovHC)
```

a.

For a female who does not work, the gpa is 3.283 on average. 

The average gpa is 0.104 lower for a male student.

The average gpa is 0.0112 lower for a student who works.

b. 
```{r}
men = data[data$male==1,]
reg2 = lm(gpa~freshman+sophomore+junior+senior,data=men)
coeftest(reg2, vcov=vcovHC)
```

Not all the coefficients are reported. Because of multi-colinearity, R automatically omit one of the four variables, freshman, sophomore, junior, and senior (in this case, *senior* is omitted). 

c.
```{r}
reg3 = lm(gpa~sophomore+junior+senior,data=men)
coeftest(reg3, vcov=vcovHC)
```

The average gpa for a fresh man is 3.109.

The average gpa for a male sophomore student is 0.035 than a fresh man.

The average gpa for a male junior student is 0.071 than a fresh man.

The average gpa for a male senior student is 0.145 than a fresh man.

(Are you "guys" getting better as you go through college? And are you "gals" as well? Test it yourself by running *lm(gpa~sophomore+junior+senior,data=data %>% filter(male==0))*)
d. 

$$H0:\beta_{junior} = \beta_{sophomore}$$
$$H1: \beta_{junior} \neq \beta_{sophomore}$$
There are only one restriction, q=1. The testing procedure is given as:

```{r}
linearHypothesis(reg3,"sophomore=junior",vcov=vcovHC)
```
We cannot reject the null hypothesis that sophomore and junior have significant differences in GPA. 

e.

```{r}
linearHypothesis(reg3,c("sophomore=0","junior=0","senior=0"),vcov=vcovHC)
```

The F-statistic is 9.643, the p-value is 2.453e-06. Thus, we can reject the null hypothesis at the 5% significance level (with a critical value of 2.6 with df=3) and conclude that the coefficients are not zero. 

f.
```{r}
reg4 = lm(gpa~age+sophomore+junior+senior,data=men)
coeftest(reg4, vcov=vcovHC)
```
The coefficient for junior are no longer statistically significant, and so does the coefficient for age. Because age might be imperfectly correlated with the combination of sophomore, junior, and senior. Imperfect multicollinearity reduces the precision of the estimates, and thus increases the standard errors. 

g.

```{r}
reg5 = lm(gpa~sophomore+junior+senior+male+work+marijuana+lightdrinker+moddrinker+heavydrinker,data=data)
# retain model structure
new_data = reg5$model[1,-1]
# feed in new data
new_data[1,] = c(0,0,1,1,1,0,0,1,0)
predict(reg5,new_data)
```
The predicted GPA is 3.220.

h.
```{r}
coeftest(reg5,vcov=vcovHC)
```

This is essentially testing the null hypothesis that $\beta_{sophomore}=0$. The t value is 3.9372 and the p-value is 8.300e-05. Thus, we can reject the null hypothesis and conclude that there is difference between freshman and sophomore. 

i.

The adjusted r square is 0.0319. It means that the fitness of our regression is low: our model only explains about 3% of the variations in GPA.  

The fact of a low prediction accuracy does not indicate whether our model suffer from omitted variable bias or not, and as such, whether our model can be interpreted causal or not. OMB is a problem when their are omitted factors in the error term, u, that is correlated with the year of students. This information is not, however, contained in $R^2$.  

